module.exports=[75805,a=>{"use strict";var b=a.i(87924),c=a.i(38246),d=a.i(72131),e=a.i(66516),f=a.i(58834);let g=["physical","mental","magic","intelligence","diplomacy","incivility"],h=[{key:"acrobatics",label:"Acrobatics",ability:"physical"},{key:"athletics",label:"Athletics",ability:"physical"},{key:"communication",label:"Communication",ability:"diplomacy"},{key:"deception",label:"Deception",ability:"incivility"},{key:"history",label:"History",ability:"intelligence"},{key:"identification",label:"Identification",ability:"magic"},{key:"insight",label:"Insight",ability:"diplomacy"},{key:"intimidation",label:"Intimidation",ability:"incivility"},{key:"investigation",label:"Investigation",ability:"intelligence"},{key:"learning",label:"Learning",ability:"mental"},{key:"perception",label:"Perception",ability:"mental"},{key:"performance",label:"Performance",ability:"incivility"},{key:"persuasion",label:"Persuasion",ability:"diplomacy"},{key:"sleight_of_hand",label:"Sleight of Hand",ability:"physical"},{key:"spells",label:"Spells",ability:"magic"}],i=[{key:"astronomy",label:"Astronomy"},{key:"care_of_magical_creatures",label:"Care of Magical Creatures"},{key:"charms",label:"Charms"},{key:"defense_against_the_dark_arts",label:"Defense Against the Dark Arts"},{key:"herbology",label:"Herbology"},{key:"potions",label:"Potions"},{key:"transfiguration",label:"Transfiguration"}],j=["F","E","D","C","B","A"];function k(a){return a>=0?`+${a}`:`${a}`}function l(a){let b=Number(a);return Number.isFinite(b)?b:0}function m(a,b){let c=Object.fromEntries(b.map(a=>[a,0]));for(let d of a)if(d)for(let a of b)c[a]+=l(d[a]);return c}function n(){return{subjects:i.map(a=>({key:a.key,grade:"F",proficient:!1})),notes:""}}function o(a){let b=n(),c=new Map;if(a&&Array.isArray(a.subjects))for(let b of a.subjects)b&&"string"==typeof b.key&&c.set(b.key,b);return{subjects:i.map(a=>{let b=c.get(a.key),d="string"==typeof b?.grade&&j.includes(b.grade)?b.grade:"F";return{key:a.key,grade:d,proficient:!!b?.proficient}}),notes:"string"==typeof a?.notes?a.notes:b.notes}}function p({characterName:a,sheetRaw:c,legacyReportCard:e,itemsRaw:f}){let p=(0,d.useMemo)(()=>(function(a,b){let c=JSON.parse(JSON.stringify({level:1,proficiencyBonus:0,abilities:{physical:10,mental:10,magic:10,intelligence:10,diplomacy:10,incivility:10},savingThrowProficiencies:Object.fromEntries(g.map(a=>[a,!1])),skillProficiencies:Object.fromEntries(h.map(a=>[a.key,!1])),reportCard:n(),derived:{hpCurrent:10,hpMaxOverride:null,acOverride:null,initiativeOverride:null,speedOverride:null,passivePerceptionOverride:null}}));if(a&&"object"==typeof a){if(Number.isInteger(a.level)&&(c.level=a.level),Number.isInteger(a.proficiencyBonus)&&(c.proficiencyBonus=a.proficiencyBonus),a.abilities&&"object"==typeof a.abilities)for(let b of g)Number.isInteger(a.abilities[b])&&(c.abilities[b]=a.abilities[b]);if(a.savingThrowProficiencies&&"object"==typeof a.savingThrowProficiencies)for(let b of g)c.savingThrowProficiencies[b]=!!a.savingThrowProficiencies[b];if(a.skillProficiencies&&"object"==typeof a.skillProficiencies)for(let b of h)c.skillProficiencies[b.key]=!!a.skillProficiencies[b.key];if(a.derived&&"object"==typeof a.derived){let b=a.derived;Number.isInteger(b.hpCurrent)&&(c.derived.hpCurrent=b.hpCurrent),c.derived.hpMaxOverride=Number.isInteger(b.hpMaxOverride)?b.hpMaxOverride:null,c.derived.acOverride=Number.isInteger(b.acOverride)?b.acOverride:null,c.derived.initiativeOverride=Number.isInteger(b.initiativeOverride)?b.initiativeOverride:null,c.derived.speedOverride=Number.isInteger(b.speedOverride)?b.speedOverride:null,c.derived.passivePerceptionOverride=Number.isInteger(b.passivePerceptionOverride)?b.passivePerceptionOverride:null}a.reportCard&&(c.reportCard=o(a.reportCard))}return!a?.reportCard&&b&&(c.reportCard=o(b)),c})(c,e),[c,e]),r=Array.isArray(f)?f:[],s=(0,d.useMemo)(()=>r.filter(a=>a?.kind==="equipment"&&a?.equipped&&(a.qty??0)>0),[r]),t=(0,d.useMemo)(()=>m(s.map(a=>a.modifiers?.abilities),g),[s]),u=(0,d.useMemo)(()=>m(s.map(a=>a.modifiers?.saves),g),[s]),v=(0,d.useMemo)(()=>{let a=h.map(a=>a.key);return m(s.map(a=>a.modifiers?.skills),a)},[s]),w=(0,d.useMemo)(()=>{let a={hpMax:0,ac:0,initiative:0,speed:0,passivePerception:0};for(let b of s){let c=b.modifiers?.derived;c&&(a.hpMax+=l(c.hpMax),a.ac+=l(c.ac),a.initiative+=l(c.initiative),a.speed+=l(c.speed),a.passivePerception+=l(c.passivePerception))}return a},[s]),x=(0,d.useMemo)(()=>{let a={};for(let b of g)a[b]=(p.abilities[b]??0)+(t[b]??0);return a},[p.abilities,t]),y=(0,d.useMemo)(()=>{let a={};for(let b of g)a[b]=Math.floor((Number(x[b])-10)/2);return a},[x]),z=y.intelligence>y.mental?"intelligence":"mental";function A(a){return"learning"===a?z:h.find(b=>b.key===a).ability}let B=(0,d.useMemo)(()=>10*(p.level+y.physical),[p.level,y.physical]),C=(p.derived.hpMaxOverride??B)+w.hpMax,D=(p.derived.acOverride??10)+w.ac,E=(p.derived.initiativeOverride??y.mental)+w.initiative,F=(p.derived.speedOverride??8)+w.speed,G=(p.derived.passivePerceptionOverride??10+y.mental)+w.passivePerception,H=Math.floor((Number(p.proficiencyBonus)||0)/2);return(0,b.jsxs)("div",{className:"space-y-4 text-sm",children:[(0,b.jsxs)("div",{className:"text-xs text-gray-600",children:[(0,b.jsx)("span",{className:"font-medium text-gray-800",children:a})," · Equipped modifiers active:"," ",(0,b.jsx)("span",{className:"font-medium",children:s.length})]}),(0,b.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,b.jsx)("div",{className:"font-medium",children:"Derived"}),(0,b.jsxs)("div",{className:"grid gap-2 grid-cols-2",children:[(0,b.jsx)(q,{label:"HP",value:`${p.derived.hpCurrent} / ${C}`}),(0,b.jsx)(q,{label:"AC",value:String(D)}),(0,b.jsx)(q,{label:"Initiative",value:k(E)}),(0,b.jsx)(q,{label:"Speed",value:String(F)}),(0,b.jsx)(q,{label:"Passive Perception",value:String(G)})]})]}),(0,b.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,b.jsx)("div",{className:"font-medium",children:"Abilities"}),(0,b.jsx)("div",{className:"grid gap-2 grid-cols-2",children:g.map(a=>(0,b.jsxs)("div",{className:"border rounded-lg p-2",children:[(0,b.jsx)("div",{className:"text-xs text-gray-600 capitalize",children:a}),(0,b.jsxs)("div",{className:"font-medium",children:[x[a]," ",(0,b.jsxs)("span",{className:"text-xs text-gray-500",children:["(",k(y[a]),")"]})]})]},a))})]}),(0,b.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,b.jsx)("div",{className:"font-medium",children:"Saving throws"}),(0,b.jsx)("div",{className:"grid gap-2 grid-cols-2",children:g.map(a=>{var c;return(0,b.jsxs)("div",{className:"border rounded-lg p-2 flex items-center justify-between gap-2",children:[(0,b.jsx)("div",{className:"capitalize",children:a}),(0,b.jsx)("div",{className:"font-semibold",children:k((c=p.savingThrowProficiencies[a],y[a]+(c?p.proficiencyBonus:0)+(u[a]??0)))})]},a)})})]}),(0,b.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,b.jsx)("div",{className:"font-medium",children:"Skills"}),(0,b.jsx)("div",{className:"space-y-1",children:h.map(a=>{var c;return(0,b.jsxs)("div",{className:"border rounded-lg px-2 py-1 flex items-center justify-between gap-2",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)("div",{className:"font-medium truncate",children:a.label}),(0,b.jsxs)("div",{className:"text-[11px] text-gray-500",children:["base: ",(0,b.jsx)("span",{className:"capitalize",children:A(a.key)}),"learning"===a.key?" (higher of Men/Int)":""]})]}),(0,b.jsx)("div",{className:"font-semibold",children:k(y[A(c=a.key)]+(p.skillProficiencies[c]?p.proficiencyBonus:0)+(v[c]??0))})]},a.key)})})]}),(0,b.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,b.jsx)("div",{className:"font-medium",children:"Knowledge (Report card)"}),(0,b.jsxs)("div",{className:"text-xs text-gray-600",children:["Proficient increases effective grade by ",(0,b.jsx)("span",{className:"font-medium",children:H})," (cap A)"]}),(0,b.jsx)("div",{className:"space-y-1",children:i.map(a=>{var c,d,e,f;let g,h=p.reportCard.subjects.find(b=>b.key===a.key)??{key:a.key,grade:"F",proficient:!1},i=(c=h.grade,d=h.proficient,e=p.proficiencyBonus,g=j.indexOf(c),j[f=g+(d?Math.floor((Number(e)||0)/2):0),Math.max(0,Math.min(j.length-1,f))]);return(0,b.jsxs)("div",{className:"border rounded-lg px-2 py-1 flex items-center justify-between gap-2",children:[(0,b.jsx)("div",{className:"font-medium",children:a.label}),(0,b.jsxs)("div",{className:"text-xs text-gray-600",children:[h.grade," ",h.proficient?"→":" "," ",(0,b.jsx)("span",{className:"font-semibold",children:i})]})]},a.key)})}),p.reportCard.notes?.trim()?(0,b.jsx)("div",{className:"border rounded-lg p-2 text-xs text-gray-700 whitespace-pre-wrap",children:p.reportCard.notes}):(0,b.jsx)("div",{className:"text-xs text-gray-500",children:"No report card notes."})]})]})}function q({label:a,value:c}){return(0,b.jsxs)("div",{className:"border rounded-lg p-2",children:[(0,b.jsx)("div",{className:"text-xs text-gray-600",children:a}),(0,b.jsx)("div",{className:"font-semibold",children:c})]})}let r="/api/encounter/play/campaign-player-notes";function s({campaignId:a}){let{state:c,setValue:e,flushSave:f}=function(a){let[b,c]=(0,d.useState)({value:"",isLoading:!0,isSaving:!1,error:null,lastSavedAt:null}),e=(0,d.useRef)(""),f=(0,d.useMemo)(()=>!!a&&a.length>0,[a]),g=(0,d.useCallback)(async()=>{if(!f){c(a=>({...a,isLoading:!1,value:"",error:null})),e.current="";return}c(a=>({...a,isLoading:!0,error:null}));try{let b=`${r}?campaignId=${encodeURIComponent(a)}`,d=await fetch(b,{method:"GET"}),f=await d.json().catch(()=>({}));if(!d.ok)throw Error(f?.error||`failed_to_load_notes_http_${d.status}`);let g="string"==typeof f?.body?f.body:"";e.current=g,c(a=>({...a,value:g,isLoading:!1,error:null,lastSavedAt:f?.updated_at??null}))}catch(a){c(b=>({...b,isLoading:!1,error:a?.message||"failed_to_load_notes"}))}},[f,a]);return(0,d.useEffect)(()=>{g()},[g]),{state:b,setValue:(0,d.useCallback)(a=>{c(b=>({...b,value:a}))},[]),load:g,flushSave:(0,d.useCallback)(async b=>{if(f&&b!==e.current){c(a=>({...a,isSaving:!0,error:null}));try{let d=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaignId:a,body:b})}),f=await d.json().catch(()=>({}));if(!d.ok)throw Error(f?.error||`failed_to_save_notes_http_${d.status}`);e.current=b,c(a=>({...a,isSaving:!1,error:null,lastSavedAt:f?.updated_at??new Date().toISOString()}))}catch(a){c(b=>({...b,isSaving:!1,error:a?.message||"failed_to_save_notes"}))}}},[f,a])}}(a),g=(0,d.useRef)(null);return(0,d.useEffect)(()=>(g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{f(c.value)},600),()=>clearTimeout(g.current)),[c.value,f]),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("div",{className:"text-sm font-medium",children:"Notes"}),(0,b.jsx)("div",{className:"text-[11px] text-gray-500",children:c.isLoading?"Loading…":c.isSaving?"Saving…":c.lastSavedAt?"Saved":""})]}),c.error?(0,b.jsx)("div",{className:"text-xs text-red-600 break-words",children:c.error}):null,(0,b.jsx)("textarea",{className:"w-full min-h-[260px] resize-y rounded-xl border p-2 text-sm",value:c.value,onChange:a=>e(a.target.value),placeholder:"Write notes here…"})]})}var t=a.i(7957);function u({campaignId:a}){let{state:c}=(0,t.useCampaignQuestLog)(a,{canEdit:!1});return(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("div",{className:"text-sm font-medium",children:"Quest log"}),(0,b.jsx)("div",{className:"text-[11px] text-gray-500",children:c.isLoading?"Loading…":c.lastSavedAt?"Live":""})]}),c.error?(0,b.jsx)("div",{className:"text-xs text-red-600 break-words",children:c.error}):null,(0,b.jsx)("div",{className:"w-full min-h-[260px] resize-y rounded-xl border p-2 text-sm",children:c.value?.trim()?c.value:"No quest log yet."})]})}function v({campaignId:a,characterId:c,characterName:e,activeEncounterId:g,bestiaryEntries:h,characterSheetRaw:i,legacyReportCardRaw:j,itemsRaw:k}){let[l,m]=(0,d.useState)("bestiary");return(0,b.jsx)("aside",{className:"w-full lg:w-[420px] shrink-0",children:(0,b.jsxs)("div",{className:"border rounded-2xl p-3 lg:sticky lg:top-6 max-h-[calc(100vh-3rem)] overflow-hidden",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,b.jsx)("div",{className:"font-medium",children:"Reference"}),(0,b.jsx)("div",{className:"text-[11px] text-gray-500",children:"Always visible"})]}),(0,b.jsxs)("div",{className:"mt-2 grid grid-cols-4 gap-2",children:[(0,b.jsx)(w,{active:"bestiary"===l,onClick:()=>m("bestiary"),children:"Bestiary"}),(0,b.jsx)(w,{active:"sheet"===l,onClick:()=>m("sheet"),children:"Character"}),(0,b.jsx)(w,{active:"notes"===l,onClick:()=>m("notes"),children:"Notes"}),(0,b.jsx)(w,{active:"quest"===l,onClick:()=>m("quest"),children:"Quest"})]}),(0,b.jsxs)("div",{className:"mt-3 border rounded-xl p-3 overflow-y-auto max-h-[calc(100vh-10rem)]",children:["bestiary"===l?h.length?(0,b.jsx)(f.default,{entries:h,variant:"reference"}):(0,b.jsx)("div",{className:"text-sm text-gray-600",children:"Nothing revealed to you yet."}):null,"sheet"===l?i?(0,b.jsx)(p,{characterName:e,sheetRaw:i,legacyReportCard:j,itemsRaw:k}):(0,b.jsx)("div",{className:"text-sm text-gray-600",children:"No character sheet found."}):null,"notes"===l?(0,b.jsx)(s,{campaignId:a,encounterId:g,characterId:c}):null,"quest"===l?(0,b.jsx)(u,{campaignId:a}):null]})]})})}function w({active:a,onClick:c,children:d}){return(0,b.jsx)("button",{type:"button",onClick:c,className:`px-3 py-2 rounded-xl border text-sm ${a?"bg-black text-white border-black":"hover:bg-gray-50"}`,children:d})}function x(a){if(a&&"object"==typeof a)return a;if("string"==typeof a)try{let b=JSON.parse(a);return b&&"object"==typeof b?b:{}}catch{}return{}}function y({campaignId:a,characterId:f,characterName:g}){let h=(0,d.useMemo)(()=>(0,e.createSupabaseBrowserClient)(),[]),i=(0,d.useRef)(null),j=(0,d.useRef)(!1),k=(0,d.useRef)(Date.now()),l=(0,d.useRef)(!1),m=(0,d.useRef)(null);function n(){k.current=Date.now(),j.current||(j.current=!0,setTimeout(async()=>{j.current=!1,await aw({silent:!0})},150))}let[o,p]=(0,d.useState)(!0),[q,r]=(0,d.useState)(null),[s,t]=(0,d.useState)(null),[u,w]=(0,d.useState)(null),[y,z]=(0,d.useState)([]),[A,B]=(0,d.useState)(null),[C,D]=(0,d.useState)({}),[E,F]=(0,d.useState)({}),[G,H]=(0,d.useState)([]),[I,J]=(0,d.useState)(null),[K,L]=(0,d.useState)(null),[M,N]=(0,d.useState)(null),[O,P]=(0,d.useState)(null),[Q,R]=(0,d.useState)(!1),[S,T]=(0,d.useState)(null),[U,V]=(0,d.useState)(null),[W,X]=(0,d.useState)(null),[Y,Z]=(0,d.useState)(null),[$,_]=(0,d.useState)(""),[aa,ab]=(0,d.useState)([]),[ac,ad]=(0,d.useState)([]),[ae,af]=(0,d.useState)(null),[ag,ah]=(0,d.useState)(null),[ai,aj]=(0,d.useState)([]),ak=s?.active_encounter_id??null;i.current=ak;let al=(0,d.useMemo)(()=>{let a=[...A?.hand??[]];return a.sort((a,b)=>(C[a]??"").localeCompare(C[b]??"")),a},[A?.hand,C]),am=null===I?null:al[I]??null;async function an(a){if(r(null),!A?.id)return void r("No combat deck for this encounter.");let b=await fetch("/api/encounter/play/hand/to-discard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deckStateId:A.id,cardId:a})}),c=await b.json().catch(()=>({}));b.ok?(J(null),await aw()):r(c?.error??"Failed to move card")}async function ao(b,c){if(!ak)return;let d=C[c]??"",e=await fetch("/api/encounter/play/log-card",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaignId:a,encounterId:ak,characterId:f,action:b,cardId:c,cardName:d})}),g=await e.json().catch(()=>({}));e.ok||r(g?.error??"Failed to write log")}async function ap(){if(r(null),!A?.id)return void r("No combat deck for this encounter.");let a=await fetch("/api/encounter/play/draw-to-limit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deckStateId:A.id})}),b=await a.json().catch(()=>({}));a.ok?await aw():r(b?.error??"Failed to draw")}async function aq(){if(r(null),!ak)return;let b=await fetch("/api/encounter/play/set-hp-current",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaignId:a,encounterId:ak,characterId:f,hpCurrent:$})}),c=await b.json().catch(()=>({}));if(!b.ok)return void r(c?.error??"Failed to update HP");let d=Number.isFinite(Number(c?.hpCurrent))?Math.trunc(Number(c.hpCurrent)):null,e=Number.isFinite(Number(c?.hpMax))?Math.trunc(Number(c.hpMax)):null;X(d),null!==e&&Z(e),l.current=!1,_(null===d?"":String(d)),U&&null!==d&&z(a=>a.map(a=>a.id===U?{...a,hp_current:d,hp_max:e??a.hp_max}:a)),setTimeout(()=>n(),400)}async function ar(b){let{data:c,error:d}=await h.from("encounter_log").select("id, created_at, kind, visibility, payload").eq("campaign_id",a).eq("encounter_id",b).order("created_at",{ascending:!1}).limit(50);d||ab(c??[])}async function as(a){let b={},c={};for(let d of a??[]){let a=String(d.id);b[a]=d.name??"(unnamed)";let e=x(d.structured),f="string"==typeof d.image_path?d.image_path:null,g="string"==typeof e?.image_path?e.image_path:null,i=f??g;if(i){let{data:b}=h.storage.from("card-images").getPublicUrl(i);c[a]=b?.publicUrl??null}else c[a]=null}D(a=>({...a,...b})),F(a=>({...a,...c}))}async function at(a){N(a),P(null),T(null),R(!0);let{data:b,error:c}=await h.from("cards").select("id,name,rules_text,image_path,structured").eq("id",a).maybeSingle();if(c||!b){T(c?.message??"Card not found"),R(!1);return}let d=x(b.structured),e="string"==typeof b.image_path?b.image_path:null,f="string"==typeof d?.image_path?d.image_path:null,g=e??f,i=g?h.storage.from("card-images").getPublicUrl(g).data?.publicUrl??null:null;P({...b,imageUrl:i}),R(!1)}async function au(){let{data:b,error:c}=await h.from("decks").select("id").eq("campaign_id",a).eq("character_id",f).eq("deck_type","exploration").maybeSingle();if(c)return void r(c.message);if(!b?.id)return void H([]);let{data:d,error:e}=await h.from("deck_cards").select("card_id, quantity").eq("deck_id",b.id);if(e)return void r(e.message);let g=(d??[]).map(a=>({card_id:a.card_id,qty:Number(a.quantity??0)})).filter(a=>a.card_id&&a.qty>0);H(g);let i=g.map(a=>a.card_id);if(i.length>0){let{data:a,error:b}=await h.from("cards").select("id,name,structured,image_path").in("id",i);if(b)return void r(b.message);await as(a??[])}}async function av(){let b,c,d,e,g,{data:i,error:j}=await h.from("bestiary_entries").select("id,category,reveal_level,created_at,revealed").eq("campaign_id",a).eq("character_id",f).order("category",{ascending:!0}).order("created_at",{ascending:!1});j&&r(j.message),ad(i??[]);let{data:k,error:l}=await h.from("characters").select("sheet").eq("id",f).eq("campaign_id",a).single();if(l)return void r(l.message);let m=k?.sheet??{},n=(b=m?.characterSheet??{},c=b?.hp??{},d=b?.derived??{},e=c?.current??b?.hpCurrent??b?.currentHp??null,g=d?.hpMaxOverride??d?.hpCurrent??c?.max??b?.hpMax??b?.maxHp??null,{current:Number.isFinite(Number(e))?Number(e):null,max:Number.isFinite(Number(g))?Number(g):null});X(n.current),Z(n.max),_(null===n.current?"":String(n.current));let o=m.characterSheet??null,p=m.reportCard??null,q=Array.isArray(m.items)?m.items:[];af(o),ah(p),aj(q)}async function aw(b){let c=!!b?.silent;c||p(!0),r(null);let{data:d,error:e}=await h.from("campaign_state").select("campaign_id, mode, active_encounter_id").eq("campaign_id",a).maybeSingle();if(e){r(e.message),c||p(!1);return}if(t(d??{campaign_id:a,mode:"exploration",active_encounter_id:null}),"combat"===(d?.mode??"exploration")&&d?.active_encounter_id){let b=d.active_encounter_id,{data:e,error:g}=await h.from("encounters").select("id, status, round_number, turn_index").eq("id",b).single();if(g){r(g.message),c||p(!1);return}w(e);let{data:i,error:j}=await h.from("encounter_log").select("id, created_at, kind, visibility, payload").eq("campaign_id",a).eq("encounter_id",b).order("created_at",{ascending:!1}).limit(30);if(j){r(j.message),c||p(!1);return}ab(i??[]);let{data:k,error:n}=await h.from("encounter_combatants").select("id, kind, name, character_id, order_index, is_hidden, is_defeated, status_public, death_saves_successes, death_saves_failures, hp_current, hp_max").eq("campaign_id",a).eq("encounter_id",b).order("order_index",{ascending:!0}).order("created_at",{ascending:!0});if(n){r(n.message),c||p(!1);return}z(k??[]);let o=(k??[]).find(a=>"character"===a.kind&&a.character_id===f);V(o?.id??null),"number"==typeof o?.hp_current&&o.hp_current,"number"==typeof o?.hp_max&&o.hp_max;let q="number"==typeof o?.hp_current?o.hp_current:null,s="number"==typeof o?.hp_max?o.hp_max:null,t=m.current;t&&Date.now()<t.until?(q!==t.cur&&(q=t.cur),null!==t.max&&s!==t.max&&(s=t.max)):t&&(m.current=null),t&&q===t.cur&&(m.current=null),X(q),Z(s),l.current||_(null===q?"":String(q));let{data:u,error:v}=await h.from("combat_deck_state").select("id,campaign_id,encounter_id,character_id,deck_id,hand_limit,draw_pile,hand,discard_pile,updated_at").eq("campaign_id",a).eq("encounter_id",b).eq("character_id",f).maybeSingle();if(v){r(v.message),c||p(!1);return}B(u??null);let x=Array.from(new Set([...u?.draw_pile??[],...u?.hand??[],...u?.discard_pile??[]]));if(x.length>0){let{data:a,error:b}=await h.from("cards").select("id,name,structured,image_path").in("id",x);if(b){r(b.message),c||p(!1);return}await as(a??[])}H([]),c||p(!1);return}w(null),ab([]),z([]),B(null),await au(),c||p(!1)}(0,d.useEffect)(()=>{aw(),av()},[a]),(0,d.useEffect)(()=>{if(!a)return;let b={current:"INIT"},c=h.channel(`play-${a}`).on("postgres_changes",{event:"*",schema:"public",table:"campaign_state",filter:`campaign_id=eq.${a}`},()=>n()).on("postgres_changes",{event:"*",schema:"public",table:"encounters",filter:`campaign_id=eq.${a}`},()=>n()).on("postgres_changes",{event:"*",schema:"public",table:"encounter_combatants",filter:`campaign_id=eq.${a}`},()=>n()).on("postgres_changes",{event:"*",schema:"public",table:"combat_deck_state",filter:`campaign_id=eq.${a}`},a=>{(a.new?.character_id??a.old?.character_id??null)===f&&n()}).on("postgres_changes",{event:"*",schema:"public",table:"encounter_log",filter:`campaign_id=eq.${a}`},()=>{let a=i.current;a&&ar(a)}).subscribe(a=>{b.current=a}),d=setInterval(()=>{Date.now()-k.current>4e3&&n();let a=i.current;a&&ar(a)},2e3);return()=>{clearInterval(d),h.removeChannel(c)}},[a,f]);let ax=y.filter(a=>!a.is_defeated),ay=u?.turn_index??0,az=ax[ay],aA=az?.character_id===f,aB=s?.mode??"exploration",aC=A?.draw_pile?.length??0,aD=A?.hand?.length??0,aE=A?.discard_pile?.length??0,aF=A?.hand_limit??4,aG=[...G].sort((a,b)=>(C[a.card_id]??"").localeCompare(C[b.card_id]??""));return(0,b.jsxs)("main",{className:"p-6 pb-56",children:[(0,b.jsxs)("header",{className:"space-y-2 max-w-6xl",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-2xl font-semibold",children:"Play"}),(0,b.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,b.jsx)("span",{className:"font-medium text-gray-800",children:"You:"})," ",g," · ",(0,b.jsx)("span",{className:"font-medium text-gray-800",children:"Mode:"})," ",s?.mode??"unknown"]})]}),(0,b.jsxs)("div",{className:"flex gap-2 flex-wrap",children:[(0,b.jsx)(c.default,{className:"underline text-sm",href:`/app/c/${a}`,children:"← Back to campaign"}),(0,b.jsx)("button",{onClick:()=>{aw(),av()},disabled:o,className:"px-3 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50",children:"Reload"})]})]}),q?(0,b.jsxs)("p",{className:"text-sm text-red-600",children:["Error: ",q]}):null]}),(0,b.jsxs)("div",{className:"max-w-6xl mt-6 lg:flex gap-4",children:[(0,b.jsxs)("section",{className:"flex-1 border rounded-2xl p-4 space-y-4 min-w-0",children:[(0,b.jsx)("h2",{className:"font-medium",children:"Encounter"}),ak?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"flex gap-4 flex-wrap text-sm text-gray-600",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("span",{className:"font-medium text-gray-800",children:"Round:"})," ",u?.round_number??"?"]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("span",{className:"font-medium text-gray-800",children:"Turn:"})," ",0===ax.length?"?":`${ay+1} / ${ax.length}`]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("span",{className:"font-medium text-gray-800",children:"Status:"})," ",u?.status??"?"]})]}),s?.mode==="combat"?(0,b.jsxs)("div",{className:`border rounded-xl p-3 ${aA?"bg-green-50 border-green-300":""}`,children:[(0,b.jsx)("div",{className:"font-medium",children:aA?"✅ It’s your turn!":"Waiting..."}),(0,b.jsxs)("div",{className:"text-sm text-gray-600",children:["Current: ",az?.name??"(unknown)"]})]}):null,(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("h3",{className:"font-medium",children:"Turn order"}),(0,b.jsx)("ul",{className:"space-y-2",children:y.map(a=>{var c;let d=ax.findIndex(b=>b.id===a.id),e=d===ay&&-1!==d;return(0,b.jsxs)("li",{className:`border rounded-xl p-3 ${e?"bg-yellow-50 border-yellow-300":""} ${a.is_defeated?"opacity-60":""}`,children:[(0,b.jsxs)("div",{className:"font-medium",children:[e?"⭐ ":"",a.name??"(no name)",a.character_id===f?" (you)":""]}),(0,b.jsxs)("div",{className:"text-xs text-gray-500",children:["kind: ",a.kind," · defeated: ",String(a.is_defeated)]}),"character"===a.kind?(0,b.jsxs)("div",{className:"mt-2 flex items-center gap-2 flex-wrap text-xs text-gray-600",children:[(0,b.jsx)("span",{className:"font-medium text-gray-700",children:"Death saves:"}),(0,b.jsxs)("span",{className:"border rounded-full px-2 py-1",children:["✅ ",a.death_saves_successes??0,"/3"]}),(0,b.jsxs)("span",{className:"border rounded-full px-2 py-1",children:["❌ ",a.death_saves_failures??0,"/3"]})]}):null,"character"===a.kind&&a.character_id===f?(0,b.jsxs)("div",{className:"mt-2 flex items-center gap-2 flex-wrap",children:[(0,b.jsx)("span",{className:"text-xs text-gray-500",children:"HP:"}),(0,b.jsx)("input",{className:"px-2 py-1 border rounded-md w-20",inputMode:"numeric",value:$,onChange:a=>{l.current=!0,_(a.target.value)},placeholder:null===W?"?":String(W)}),(0,b.jsxs)("span",{className:"text-xs text-gray-500",children:["/ ",Y??"?"]}),(0,b.jsx)("button",{type:"button",onClick:aq,disabled:o||!U,className:"px-3 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50 text-sm",children:"Save HP"})]}):null,(0,b.jsx)("div",{className:"flex gap-2 flex-wrap mt-2",children:(!Array.isArray(c=a.status_public)?[]:c.map(a=>{if("string"==typeof a)return{label:a,remaining:1};if(a&&"object"==typeof a){let b=String(a.label??"").trim(),c=Number(a.remaining);return b?{label:b,remaining:Number.isFinite(c)?c:1}:null}return null}).filter(Boolean)).map(a=>(0,b.jsxs)("span",{className:"border rounded-full px-3 py-1 text-sm",children:[a.label," (",a.remaining,")"]},a.label))})]},a.id)})})]}),(0,b.jsxs)("section",{className:"border rounded-2xl p-4 space-y-2",children:[(0,b.jsx)("h3",{className:"font-medium",children:"Encounter log"}),0===aa.length?(0,b.jsx)("div",{className:"text-sm text-gray-500",children:"No log entries yet."}):(0,b.jsx)("ul",{className:"space-y-2",children:aa.map(a=>{let c=a.payload??{},d="";if("note"===a.kind)d=String(c.text??"").trim()||"(note)";else if("card"===a.kind){let a=c.action,b=c.card_name??"(card)",e=c.character_name??"Someone";d=`${e} ${"play"===a?"played":"discarded"} ${b}`}else d=`${a.kind??"log"} entry`;return(0,b.jsx)("li",{className:"text-sm",children:"card"===a.kind?(0,b.jsxs)("div",{children:[(0,b.jsxs)("span",{children:[c.character_name??"Someone"," "]}),(0,b.jsxs)("span",{children:["play"===c.action?"played":"discarded"," "]}),(0,b.jsx)("button",{type:"button",className:"underline",onClick:()=>{let a="string"==typeof c.card_id?c.card_id:"";a&&at(a)},children:c.card_name??"(card)"}),(0,b.jsx)("div",{className:"text-xs text-gray-500",children:new Date(a.created_at).toLocaleString()})]}):(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{children:d}),(0,b.jsx)("div",{className:"text-xs text-gray-500",children:new Date(a.created_at).toLocaleString()})]})},a.id)})})]})]}):(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"No active encounter."})]}),(0,b.jsx)(v,{campaignId:a,characterId:f,characterName:g,activeEncounterId:ak,bestiaryEntries:ac,characterSheetRaw:ae,legacyReportCardRaw:ag,itemsRaw:ai})]}),(0,b.jsx)("div",{className:"fixed bottom-0 left-0 right-0 border-t bg-white/95 backdrop-blur",children:(0,b.jsx)("div",{className:"max-w-6xl mx-auto p-3 space-y-2",children:"combat"===aB?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"flex items-end gap-3",children:[(0,b.jsxs)("button",{type:"button",onClick:()=>L("discard"===K?null:"discard"),className:"w-[140px] border rounded-2xl p-3 hover:bg-gray-50 text-left shrink-0",children:[(0,b.jsx)("div",{className:"text-xs text-gray-600",children:"Discard"}),(0,b.jsx)("div",{className:"font-semibold",children:aE}),(0,b.jsx)("div",{className:"text-[11px] text-gray-500",children:"Tap to view"})]}),(0,b.jsxs)("div",{className:"flex-1 min-w-0 border rounded-2xl p-3",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,b.jsxs)("div",{className:"text-xs text-gray-600",children:["Hand (",aD," / ",aF,")"]}),(0,b.jsx)("button",{onClick:ap,disabled:o||!A,className:"px-3 py-2 rounded-xl border hover:bg-gray-50 disabled:opacity-50 text-sm",title:"Draw until you reach your hand limit",children:"Draw to limit"})]}),A?0===aD?(0,b.jsx)("div",{className:"text-sm text-gray-500 mt-2",children:"Empty"}):(0,b.jsx)("div",{className:"mt-3 overflow-x-auto",children:(0,b.jsx)("div",{className:"flex gap-4 justify-center min-w-max px-2",children:al.map((a,c)=>{let d=I===c,e=C[a]??a,f=E[a]??null;return(0,b.jsxs)("div",{className:"w-[160px]",children:[(0,b.jsxs)("button",{type:"button",onClick:()=>J(d?null:c),onContextMenu:b=>{b.preventDefault(),at(a)},className:`w-full border rounded-2xl p-2 hover:bg-gray-50 ${d?"bg-yellow-50 border-yellow-300":""}`,title:"Left click: actions · Right click: view card",children:[f?(0,b.jsx)("img",{src:f,alt:e,className:"w-full aspect-[785/1100] object-cover rounded-xl border bg-white"}):(0,b.jsx)("div",{className:"w-full aspect-[785/1100] rounded-xl border bg-gray-50 grid place-items-center text-xs text-gray-500",children:"No image"}),(0,b.jsx)("div",{className:"mt-2 text-sm font-medium leading-tight line-clamp-2",children:e})]}),d&&am?(0,b.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[(0,b.jsx)("button",{type:"button",onClick:async()=>{await an(am),await ao("play",am)},disabled:o,className:"px-3 py-2 rounded-xl border hover:bg-gray-50 disabled:opacity-50 text-sm",children:"Play"}),(0,b.jsx)("button",{type:"button",onClick:async()=>{await an(am),await ao("discard",am)},disabled:o,className:"px-3 py-2 rounded-xl border hover:bg-gray-50 disabled:opacity-50 text-sm",children:"Discard"})]}):null]},`${a}-${c}`)})})}):(0,b.jsx)("div",{className:"text-sm text-gray-500 mt-2",children:"No combat deck for this encounter."})]}),(0,b.jsxs)("button",{onClick:()=>L("draw"===K?null:"draw"),className:"w-[140px] border rounded-2xl p-3 hover:bg-gray-50 text-left shrink-0",children:[(0,b.jsx)("div",{className:"text-xs text-gray-600",children:"Deck"}),(0,b.jsx)("div",{className:"font-semibold",children:aC}),(0,b.jsx)("div",{className:"text-[11px] text-gray-500",children:"Tap to view"})]})]}),K?(0,b.jsx)("div",{className:"px-1 pb-1",children:(0,b.jsxs)("div",{className:"border rounded-2xl p-3 space-y-2",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[(0,b.jsxs)("div",{className:"text-sm text-gray-700",children:["Viewing ",(0,b.jsx)("span",{className:"font-medium",children:K})," pile (alphabetical)"]}),(0,b.jsx)("button",{type:"button",className:"underline text-sm",onClick:()=>L(null),children:"close"})]}),A?(()=>{let a="draw"===K?A.draw_pile??[]:A.discard_pile??[];if(0===a.length)return(0,b.jsx)("div",{className:"text-sm text-gray-500",children:"Empty."});let c={};for(let b of a)c[b]=(c[b]??0)+1;let d=Object.entries(c).map(([a,b])=>({id:a,qty:b,name:C[a]??a})).sort((a,b)=>a.name.localeCompare(b.name));return(0,b.jsx)("ul",{className:"space-y-1",children:d.map(a=>(0,b.jsxs)("li",{className:"text-sm text-gray-700",children:[a.name," ",a.qty>1?(0,b.jsxs)("span",{className:"text-gray-500",children:["×",a.qty]}):null]},a.id))})})():(0,b.jsx)("div",{className:"text-sm text-gray-500",children:"No deck state."})]})}):null]}):(0,b.jsxs)("div",{className:"border rounded-2xl p-3",children:[(0,b.jsx)("div",{className:"text-xs text-gray-600",children:"Exploration hand"}),0===aG.length?(0,b.jsx)("div",{className:"text-sm text-gray-500 mt-2",children:"No exploration deck found."}):(0,b.jsx)("div",{className:"mt-3 overflow-x-auto",children:(0,b.jsx)("div",{className:"flex gap-4 justify-center min-w-max px-2",children:aG.map(a=>{let c=C[a.card_id]??a.card_id,d=E[a.card_id]??null;return(0,b.jsx)("div",{className:"w-[160px]",children:(0,b.jsx)("div",{className:"w-[160px]",children:(0,b.jsxs)("button",{type:"button",onContextMenu:b=>{b.preventDefault(),at(a.card_id)},className:"w-full border rounded-2xl p-2 hover:bg-gray-50 text-left",title:"Right click: view card",children:[d?(0,b.jsx)("img",{src:d,alt:c,className:"w-full aspect-[785/1100] object-cover rounded-xl border bg-white"}):(0,b.jsx)("div",{className:"w-full aspect-[785/1100] rounded-xl border bg-gray-50 grid place-items-center text-xs text-gray-500",children:"No image"}),(0,b.jsxs)("div",{className:"mt-2 flex items-start justify-between gap-2",children:[(0,b.jsx)("div",{className:"text-sm font-medium leading-tight line-clamp-2",children:c}),a.qty>1?(0,b.jsxs)("div",{className:"text-xs border rounded-full px-2 py-1",children:[a.qty,"×"]}):null]})]})},a.card_id)},a.card_id)})})}),(0,b.jsx)("div",{className:"text-xs text-gray-500 mt-2",children:"Exploration mode has no draw/discard mechanics."})]})})}),M&&(0,b.jsx)("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center p-4",onClick:()=>{N(null),P(null),T(null)},children:(0,b.jsxs)("div",{className:"bg-white text-black w-full max-w-3xl rounded-2xl p-4 space-y-3",onClick:a=>a.stopPropagation(),children:[(0,b.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-xl font-semibold",children:O?.name??(Q?"Loading…":"Card")}),S?(0,b.jsx)("div",{className:"text-sm text-red-600",children:S}):null]}),(0,b.jsx)("button",{className:"border rounded-md px-3 py-2",onClick:()=>{N(null),P(null),T(null)},children:"Close"})]}),Q?(0,b.jsx)("div",{className:"text-sm text-gray-600",children:"Loading…"}):O?(0,b.jsxs)(b.Fragment,{children:[O.imageUrl?(0,b.jsx)("img",{src:O.imageUrl,alt:O.name??"Card",className:"w-full max-h-[420px] object-contain rounded-lg border bg-white"}):(0,b.jsx)("div",{className:"w-full h-[220px] rounded-lg border bg-gray-50 grid place-items-center text-sm text-gray-500",children:"No image"}),(0,b.jsx)("div",{className:"max-h-[45vh] overflow-y-auto pr-1",children:(0,b.jsx)("div",{className:"text-sm whitespace-pre-wrap text-gray-800",children:O.rules_text??""})})]}):null]})})]})}a.s(["default",()=>y],75805)}];

//# sourceMappingURL=src_app_app_c_%5BcampaignId%5D_play_play-client_tsx_215ad013._.js.map