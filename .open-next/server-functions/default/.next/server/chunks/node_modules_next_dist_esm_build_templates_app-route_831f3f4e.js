module.exports=[9434,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),n=e.i(59756),s=e.i(61916),i=e.i(74677),o=e.i(69741),l=e.i(16795),d=e.i(87718),u=e.i(95169),c=e.i(47587),p=e.i(66012),m=e.i(70101),g=e.i(26937),f=e.i(10372),h=e.i(93695);e.i(52474);var y=e.i(5232),R=e.i(89171),_=e.i(26500);function w(e){return Array.isArray(e)?e:[]}function v(e,t=""){return"string"==typeof e?e:t}function b(e){let t={};for(let[r,a]of Object.entries(e??{}))void 0!==a&&(t[r]=a);return t}function N(e){return e&&"object"==typeof e?e:{}}async function x(e){let t=await (0,_.createSupabaseServerClient)(),{data:r}=await t.auth.getUser(),a=r.user;if(!a)return R.NextResponse.json({error:"Not logged in"},{status:401});let n=null,s="Imported campaign";if((e.headers.get("content-type")||"").includes("multipart/form-data")){let t=await e.formData();s=v(t.get("name"),s).trim()||s;let r=t.get("file");if(!(r instanceof File))return R.NextResponse.json({error:"Missing file"},{status:400});let a=await r.text();try{n=JSON.parse(a)}catch{return R.NextResponse.json({error:"File is not valid JSON"},{status:400})}}else{let t=await e.json().catch(()=>({}));n=t?.dump??t?.export??t,s=v(t?.name,s).trim()||s}if(!n||"object"!=typeof n)return R.NextResponse.json({error:"Invalid export payload"},{status:400});let i=Number(n?.version??1),o=N(n?.tables),l=w(i>=2?o.characters:n.characters),d=w(i>=2?o.decks:n.decks),u=w(i>=2?o.deck_cards:n.deck_cards),c=w(i>=2?o.cards:n.cards),p=w(i>=2?o.monsters:n.monsters),m=w(i>=2?o.bestiary_entries:n.bestiary_entries??n.bestiaryEntries??n.bestiary),g=w(n?.assets),f=crypto.randomUUID(),{error:h}=await t.from("campaigns").insert({id:f,name:s,owner_user_id:a.id});if(h)return R.NextResponse.json({error:h.message},{status:400});let{error:y}=await t.from("campaign_members").insert({campaign_id:f,user_id:a.id,role:"dm"});if(y)return R.NextResponse.json({error:y.message},{status:400});let x=new Map,C=new Map,E=new Map,A=new Map,k=l.map(e=>{let t=v(e?.id),r=crypto.randomUUID();return t&&x.set(t,r),b({id:r,campaign_id:f,user_id:null,name:v(e?.name,"Character"),sheet:N(e?.sheet)})});if(k.length){let{error:e}=await t.from("characters").insert(k);if(e)return R.NextResponse.json({error:`Characters: ${e.message}`},{status:400})}let U=p.map(e=>{let t=v(e?.id),r=crypto.randomUUID();return t&&C.set(t,r),b({id:r,campaign_id:f,name:v(e?.name,"Monster"),tags:Array.isArray(e?.tags)?e.tags:[],gm_notes:e?.gm_notes??null,data:N(e?.data)})});if(U.length){let{error:e}=await t.from("monsters").insert(U);if(e)return R.NextResponse.json({error:`Monsters: ${e.message}`},{status:400})}let j=c.map(e=>{let t=v(e?.id),r=crypto.randomUUID();t&&E.set(t,r);let a=v(e?.rules_text,v(e?.rules,"")),n=N(e?.structured);return b({id:r,campaign_id:f,name:v(e?.name,"Card"),type:v(e?.type,""),tier:Number.isFinite(Number(e?.tier))?Number(e?.tier):null,cost:Number.isFinite(Number(e?.cost))?Number(e?.cost):null,tags:Array.isArray(e?.tags)?e.tags:[],rules_text:a,structured:n,encounter_type:v(e?.encounter_type,"combat"),rarity:v(e?.rarity,"common"),description:v(e?.description,""),max_owned:Number.isFinite(Number(e?.max_owned))?Number(e?.max_owned):1,image_path:null})});if(j.length){let{error:e}=await t.from("cards").insert(j);if(e)return R.NextResponse.json({error:`Cards: ${e.message}`},{status:400})}let T=d.map(e=>{let t=v(e?.id),r=crypto.randomUUID();t&&A.set(t,r);let a=v(e?.character_id);return b({id:r,campaign_id:f,character_id:a?x.get(a)??null:null,deck_type:v(e?.deck_type,"combat"),name:e?.name??null})});if(T.length){let{error:e}=await t.from("decks").insert(T);if(e)return R.NextResponse.json({error:`Decks: ${e.message}`},{status:400})}let O=u.map(e=>{let t=v(e?.deck_id),r=v(e?.card_id),a=t?A.get(t):null,n=r?E.get(r):null;if(!a||!n)return null;let s=Number(e?.quantity??e?.qty??0);return!Number.isFinite(s)||s<=0?null:{deck_id:a,card_id:n,quantity:s}}).filter(Boolean);if(O.length){let{error:e}=await t.from("deck_cards").insert(O);if(e)return R.NextResponse.json({error:`Deck cards: ${e.message}`},{status:400})}let S=m.map(e=>{let t=v(e?.character_id),r=v(e?.monster_id),a=t?x.get(t):null,n=r?C.get(r):null;if(!a||!n)return null;let s=N(e?.revealed);"string"==typeof s.monsterId&&(s.monsterId=n);let i=Number(e?.reveal_level??e?.revealLevel??1),o=[1,2,3].includes(i)?i:1;return b({campaign_id:f,character_id:a,monster_id:n,category:v(e?.category,"Unsorted"),reveal_level:o,revealed:s})}).filter(Boolean);if(S.length){let{error:e}=await t.from("bestiary_entries").upsert(S,{onConflict:"character_id,monster_id"});if(e)return R.NextResponse.json({error:`Bestiary: ${e.message}`},{status:400})}let I=0;for(let e of g.filter(e=>e?.kind==="card-image"&&e?.bucket==="card-images")){let r=E.get(v(e.oldCardId));if(!r)continue;let a=Buffer.from(v(e.base64),"base64"),n=e.oldPath.split("/").pop()||`${r}.png`,s=`${f}/${r}-${Date.now()}-${n}`,{error:i}=await t.storage.from("card-images").upload(s,a,{upsert:!0,contentType:e.contentType||"image/png",cacheControl:"3600"});if(i)continue;let{data:o}=await t.from("cards").select("structured").eq("id",r).eq("campaign_id",f).maybeSingle(),l={...function(e){if(e&&"object"==typeof e)return e;if("string"==typeof e)try{let t=JSON.parse(e);return t&&"object"==typeof t?t:{}}catch{}return{}}(o?.structured),image_path:s},{error:d}=await t.from("cards").update({image_path:s,structured:l}).eq("id",r).eq("campaign_id",f);d||(I+=1)}return R.NextResponse.json({ok:!0,newCampaignId:f,counts:{characters:k.length,monsters:U.length,cards:j.length,decks:T.length,deck_cards:O.length,bestiary:S.length,restored_card_images:I}})}e.s(["POST",()=>x,"runtime",0,"nodejs"],97226);var C=e.i(97226);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/campaigns/import/route",pathname:"/api/campaigns/import",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/campaigns/import/route.ts",nextConfigOutput:"standalone",userland:C}),{workAsyncStorage:A,workUnitAsyncStorage:k,serverHooks:U}=E;function j(){return(0,a.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:k})}async function T(e,t,a){E.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/campaigns/import/route";R=R.replace(/\/index$/,"")||"/";let _=await E.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!_)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:v,nextConfig:b,parsedUrl:N,isDraftMode:x,prerenderManifest:C,routerServerContext:A,isOnDemandRevalidate:k,revalidateOnlyGenerated:U,resolvedPathname:j,clientReferenceManifest:T,serverActionsManifest:O}=_,S=(0,o.normalizeAppPath)(R),I=!!(C.dynamicRoutes[S]||C.routes[j]),P=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,N,!1):t.end("This page could not be found"),null);if(I&&!x){let e=!!C.routes[j],t=C.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await P();throw new h.NoFallbackError}}let D=null;!I||E.isDev||x||(D="/index"===(D=j)?"/":D);let q=!0===E.isDev||!I,$=I&&!q;O&&T&&(0,i.setManifestsSingleton)({page:R,clientReferenceManifest:T,serverActionsManifest:O});let M=e.method||"GET",H=(0,s.getTracer)(),F=H.getActiveScopeSpan(),B={params:v,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>E.onRequestError(e,t,a,n,A)},sharedContext:{buildId:w}},K=new l.NodeNextRequest(e),L=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let i=async e=>E.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${R}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&k&&U&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(K,L,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:k})},!1,A),t}},u=await E.handleResponse({req:e,nextConfig:b,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:U,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!I)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",k?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&I||h.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(K,L,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};F?await l(F):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${M} ${R}`,kind:s.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:k})},!1,A),I)throw t;return await (0,p.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>j,"routeModule",()=>E,"serverHooks",()=>U,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>k],9434)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_831f3f4e.js.map