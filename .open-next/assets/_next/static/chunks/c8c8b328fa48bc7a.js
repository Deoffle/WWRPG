(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,20846,e=>{"use strict";var t=e.i(43476),a=e.i(22016),r=e.i(71645),i=e.i(2410),s=e.i(48694);let l=["physical","mental","magic","intelligence","diplomacy","incivility"],n=[{key:"acrobatics",label:"Acrobatics",ability:"physical"},{key:"athletics",label:"Athletics",ability:"physical"},{key:"communication",label:"Communication",ability:"diplomacy"},{key:"deception",label:"Deception",ability:"incivility"},{key:"history",label:"History",ability:"intelligence"},{key:"identification",label:"Identification",ability:"magic"},{key:"insight",label:"Insight",ability:"diplomacy"},{key:"intimidation",label:"Intimidation",ability:"incivility"},{key:"investigation",label:"Investigation",ability:"intelligence"},{key:"learning",label:"Learning",ability:"mental"},{key:"perception",label:"Perception",ability:"mental"},{key:"performance",label:"Performance",ability:"incivility"},{key:"persuasion",label:"Persuasion",ability:"diplomacy"},{key:"sleight_of_hand",label:"Sleight of Hand",ability:"physical"},{key:"spells",label:"Spells",ability:"magic"}],d=[{key:"astronomy",label:"Astronomy"},{key:"care_of_magical_creatures",label:"Care of Magical Creatures"},{key:"charms",label:"Charms"},{key:"defense_against_the_dark_arts",label:"Defense Against the Dark Arts"},{key:"herbology",label:"Herbology"},{key:"potions",label:"Potions"},{key:"transfiguration",label:"Transfiguration"}],c=["F","E","D","C","B","A"];function o(e){return e>=0?`+${e}`:`${e}`}function u(e){let t=Number(e);return Number.isFinite(t)?t:0}function m(e,t){let a=Object.fromEntries(t.map(e=>[e,0]));for(let r of e)if(r)for(let e of t)a[e]+=u(r[e]);return a}function x(){return{subjects:d.map(e=>({key:e.key,grade:"F",proficient:!1})),notes:""}}function p(e){let t=x(),a=new Map;if(e&&Array.isArray(e.subjects))for(let t of e.subjects)t&&"string"==typeof t.key&&a.set(t.key,t);return{subjects:d.map(e=>{let t=a.get(e.key),r="string"==typeof t?.grade&&c.includes(t.grade)?t.grade:"F";return{key:e.key,grade:r,proficient:!!t?.proficient}}),notes:"string"==typeof e?.notes?e.notes:t.notes}}function h({characterName:e,sheetRaw:a,legacyReportCard:i,itemsRaw:s}){let h=(0,r.useMemo)(()=>(function(e,t){let a=JSON.parse(JSON.stringify({level:1,proficiencyBonus:0,abilities:{physical:10,mental:10,magic:10,intelligence:10,diplomacy:10,incivility:10},savingThrowProficiencies:Object.fromEntries(l.map(e=>[e,!1])),skillProficiencies:Object.fromEntries(n.map(e=>[e.key,!1])),reportCard:x(),derived:{hpCurrent:10,hpMaxOverride:null,acOverride:null,initiativeOverride:null,speedOverride:null,passivePerceptionOverride:null}}));if(e&&"object"==typeof e){if(Number.isInteger(e.level)&&(a.level=e.level),Number.isInteger(e.proficiencyBonus)&&(a.proficiencyBonus=e.proficiencyBonus),e.abilities&&"object"==typeof e.abilities)for(let t of l)Number.isInteger(e.abilities[t])&&(a.abilities[t]=e.abilities[t]);if(e.savingThrowProficiencies&&"object"==typeof e.savingThrowProficiencies)for(let t of l)a.savingThrowProficiencies[t]=!!e.savingThrowProficiencies[t];if(e.skillProficiencies&&"object"==typeof e.skillProficiencies)for(let t of n)a.skillProficiencies[t.key]=!!e.skillProficiencies[t.key];if(e.derived&&"object"==typeof e.derived){let t=e.derived;Number.isInteger(t.hpCurrent)&&(a.derived.hpCurrent=t.hpCurrent),a.derived.hpMaxOverride=Number.isInteger(t.hpMaxOverride)?t.hpMaxOverride:null,a.derived.acOverride=Number.isInteger(t.acOverride)?t.acOverride:null,a.derived.initiativeOverride=Number.isInteger(t.initiativeOverride)?t.initiativeOverride:null,a.derived.speedOverride=Number.isInteger(t.speedOverride)?t.speedOverride:null,a.derived.passivePerceptionOverride=Number.isInteger(t.passivePerceptionOverride)?t.passivePerceptionOverride:null}e.reportCard&&(a.reportCard=p(e.reportCard))}return!e?.reportCard&&t&&(a.reportCard=p(t)),a})(a,i),[a,i]),f=Array.isArray(s)?s:[],y=(0,r.useMemo)(()=>f.filter(e=>e?.kind==="equipment"&&e?.equipped&&(e.qty??0)>0),[f]),v=(0,r.useMemo)(()=>m(y.map(e=>e.modifiers?.abilities),l),[y]),b=(0,r.useMemo)(()=>m(y.map(e=>e.modifiers?.saves),l),[y]),j=(0,r.useMemo)(()=>{let e=n.map(e=>e.key);return m(y.map(e=>e.modifiers?.skills),e)},[y]),N=(0,r.useMemo)(()=>{let e={hpMax:0,ac:0,initiative:0,speed:0,passivePerception:0};for(let t of y){let a=t.modifiers?.derived;a&&(e.hpMax+=u(a.hpMax),e.ac+=u(a.ac),e.initiative+=u(a.initiative),e.speed+=u(a.speed),e.passivePerception+=u(a.passivePerception))}return e},[y]),_=(0,r.useMemo)(()=>{let e={};for(let t of l)e[t]=(h.abilities[t]??0)+(v[t]??0);return e},[h.abilities,v]),w=(0,r.useMemo)(()=>{let e={};for(let t of l)e[t]=Math.floor((Number(_[t])-10)/2);return e},[_]),k=w.intelligence>w.mental?"intelligence":"mental";function S(e){return"learning"===e?k:n.find(t=>t.key===e).ability}let C=(0,r.useMemo)(()=>10*(h.level+w.physical),[h.level,w.physical]),O=(h.derived.hpMaxOverride??C)+N.hpMax,P=(h.derived.acOverride??10)+N.ac,q=(h.derived.initiativeOverride??w.mental)+N.initiative,M=(h.derived.speedOverride??8)+N.speed,I=(h.derived.passivePerceptionOverride??10+w.mental)+N.passivePerception,T=Math.floor((Number(h.proficiencyBonus)||0)/2);return(0,t.jsxs)("div",{className:"space-y-4 text-sm",children:[(0,t.jsxs)("div",{className:"text-xs text-gray-600",children:[(0,t.jsx)("span",{className:"font-medium text-gray-800",children:e})," · Equipped modifiers active:"," ",(0,t.jsx)("span",{className:"font-medium",children:y.length})]}),(0,t.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,t.jsx)("div",{className:"font-medium",children:"Derived"}),(0,t.jsxs)("div",{className:"grid gap-2 grid-cols-2",children:[(0,t.jsx)(g,{label:"HP",value:`${h.derived.hpCurrent} / ${O}`}),(0,t.jsx)(g,{label:"AC",value:String(P)}),(0,t.jsx)(g,{label:"Initiative",value:o(q)}),(0,t.jsx)(g,{label:"Speed",value:String(M)}),(0,t.jsx)(g,{label:"Passive Perception",value:String(I)})]})]}),(0,t.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,t.jsx)("div",{className:"font-medium",children:"Abilities"}),(0,t.jsx)("div",{className:"grid gap-2 grid-cols-2",children:l.map(e=>(0,t.jsxs)("div",{className:"border rounded-lg p-2",children:[(0,t.jsx)("div",{className:"text-xs text-gray-600 capitalize",children:e}),(0,t.jsxs)("div",{className:"font-medium",children:[_[e]," ",(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:["(",o(w[e]),")"]})]})]},e))})]}),(0,t.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,t.jsx)("div",{className:"font-medium",children:"Saving throws"}),(0,t.jsx)("div",{className:"grid gap-2 grid-cols-2",children:l.map(e=>{var a;return(0,t.jsxs)("div",{className:"border rounded-lg p-2 flex items-center justify-between gap-2",children:[(0,t.jsx)("div",{className:"capitalize",children:e}),(0,t.jsx)("div",{className:"font-semibold",children:o((a=h.savingThrowProficiencies[e],w[e]+(a?h.proficiencyBonus:0)+(b[e]??0)))})]},e)})})]}),(0,t.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,t.jsx)("div",{className:"font-medium",children:"Skills"}),(0,t.jsx)("div",{className:"space-y-1",children:n.map(e=>{var a;return(0,t.jsxs)("div",{className:"border rounded-lg px-2 py-1 flex items-center justify-between gap-2",children:[(0,t.jsxs)("div",{className:"min-w-0",children:[(0,t.jsx)("div",{className:"font-medium truncate",children:e.label}),(0,t.jsxs)("div",{className:"text-[11px] text-gray-500",children:["base: ",(0,t.jsx)("span",{className:"capitalize",children:S(e.key)}),"learning"===e.key?" (higher of Men/Int)":""]})]}),(0,t.jsx)("div",{className:"font-semibold",children:o(w[S(a=e.key)]+(h.skillProficiencies[a]?h.proficiencyBonus:0)+(j[a]??0))})]},e.key)})})]}),(0,t.jsxs)("section",{className:"border rounded-xl p-3 space-y-2",children:[(0,t.jsx)("div",{className:"font-medium",children:"Knowledge (Report card)"}),(0,t.jsxs)("div",{className:"text-xs text-gray-600",children:["Proficient increases effective grade by ",(0,t.jsx)("span",{className:"font-medium",children:T})," (cap A)"]}),(0,t.jsx)("div",{className:"space-y-1",children:d.map(e=>{var a,r,i,s;let l,n=h.reportCard.subjects.find(t=>t.key===e.key)??{key:e.key,grade:"F",proficient:!1},d=(a=n.grade,r=n.proficient,i=h.proficiencyBonus,l=c.indexOf(a),c[s=l+(r?Math.floor((Number(i)||0)/2):0),Math.max(0,Math.min(c.length-1,s))]);return(0,t.jsxs)("div",{className:"border rounded-lg px-2 py-1 flex items-center justify-between gap-2",children:[(0,t.jsx)("div",{className:"font-medium",children:e.label}),(0,t.jsxs)("div",{className:"text-xs text-gray-600",children:[n.grade," ",n.proficient?"→":" "," ",(0,t.jsx)("span",{className:"font-semibold",children:d})]})]},e.key)})}),h.reportCard.notes?.trim()?(0,t.jsx)("div",{className:"border rounded-lg p-2 text-xs text-gray-700 whitespace-pre-wrap",children:h.reportCard.notes}):(0,t.jsx)("div",{className:"text-xs text-gray-500",children:"No report card notes."})]})]})}function g({label:e,value:a}){return(0,t.jsxs)("div",{className:"border rounded-lg p-2",children:[(0,t.jsx)("div",{className:"text-xs text-gray-600",children:e}),(0,t.jsx)("div",{className:"font-semibold",children:a})]})}let f="/api/encounter/play/campaign-player-notes";function y({campaignId:e}){let{state:a,setValue:i,flushSave:s}=function(e){let[t,a]=(0,r.useState)({value:"",isLoading:!0,isSaving:!1,error:null,lastSavedAt:null}),i=(0,r.useRef)(""),s=(0,r.useMemo)(()=>!!e&&e.length>0,[e]),l=(0,r.useCallback)(async()=>{if(!s){a(e=>({...e,isLoading:!1,value:"",error:null})),i.current="";return}a(e=>({...e,isLoading:!0,error:null}));try{let t=`${f}?campaignId=${encodeURIComponent(e)}`,r=await fetch(t,{method:"GET"}),s=await r.json().catch(()=>({}));if(!r.ok)throw Error(s?.error||`failed_to_load_notes_http_${r.status}`);let l="string"==typeof s?.body?s.body:"";i.current=l,a(e=>({...e,value:l,isLoading:!1,error:null,lastSavedAt:s?.updated_at??null}))}catch(e){a(t=>({...t,isLoading:!1,error:e?.message||"failed_to_load_notes"}))}},[s,e]);return(0,r.useEffect)(()=>{l()},[l]),{state:t,setValue:(0,r.useCallback)(e=>{a(t=>({...t,value:e}))},[]),load:l,flushSave:(0,r.useCallback)(async t=>{if(s&&t!==i.current){a(e=>({...e,isSaving:!0,error:null}));try{let r=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaignId:e,body:t})}),s=await r.json().catch(()=>({}));if(!r.ok)throw Error(s?.error||`failed_to_save_notes_http_${r.status}`);i.current=t,a(e=>({...e,isSaving:!1,error:null,lastSavedAt:s?.updated_at??new Date().toISOString()}))}catch(e){a(t=>({...t,isSaving:!1,error:e?.message||"failed_to_save_notes"}))}}},[s,e])}}(e),l=(0,r.useRef)(null);return(0,r.useEffect)(()=>(l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{s(a.value)},600),()=>clearTimeout(l.current)),[a.value,s]),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("div",{className:"text-sm font-medium",children:"Notes"}),(0,t.jsx)("div",{className:"text-[11px] text-gray-500",children:a.isLoading?"Loading…":a.isSaving?"Saving…":a.lastSavedAt?"Saved":""})]}),a.error?(0,t.jsx)("div",{className:"text-xs text-red-600 break-words",children:a.error}):null,(0,t.jsx)("textarea",{className:"w-full min-h-[260px] resize-y rounded-xl border p-2 text-sm",value:a.value,onChange:e=>i(e.target.value),placeholder:"Write notes here…"})]})}var v=e.i(93587);function b({campaignId:e}){let{state:a}=(0,v.useCampaignQuestLog)(e,{canEdit:!1});return(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("div",{className:"text-sm font-medium",children:"Quest log"}),(0,t.jsx)("div",{className:"text-[11px] text-gray-500",children:a.isLoading?"Loading…":a.lastSavedAt?"Live":""})]}),a.error?(0,t.jsx)("div",{className:"text-xs text-red-600 break-words",children:a.error}):null,(0,t.jsx)("div",{className:"w-full min-h-[260px] resize-y rounded-xl border p-2 text-sm",children:a.value?.trim()?a.value:"No quest log yet."})]})}function j({campaignId:e,characterId:a,characterName:i,activeEncounterId:l,bestiaryEntries:n,characterSheetRaw:d,legacyReportCardRaw:c,itemsRaw:o}){let[u,m]=(0,r.useState)("bestiary");return(0,t.jsx)("aside",{className:"w-full lg:w-[420px] shrink-0",children:(0,t.jsxs)("div",{className:"border rounded-2xl p-3 lg:sticky lg:top-6 max-h-[calc(100vh-3rem)] overflow-hidden",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,t.jsx)("div",{className:"font-medium",children:"Reference"}),(0,t.jsx)("div",{className:"text-[11px] text-gray-500",children:"Always visible"})]}),(0,t.jsxs)("div",{className:"mt-2 grid grid-cols-4 gap-2",children:[(0,t.jsx)(N,{active:"bestiary"===u,onClick:()=>m("bestiary"),children:"Bestiary"}),(0,t.jsx)(N,{active:"sheet"===u,onClick:()=>m("sheet"),children:"Character"}),(0,t.jsx)(N,{active:"notes"===u,onClick:()=>m("notes"),children:"Notes"}),(0,t.jsx)(N,{active:"quest"===u,onClick:()=>m("quest"),children:"Quest"})]}),(0,t.jsxs)("div",{className:"mt-3 border rounded-xl p-3 overflow-y-auto max-h-[calc(100vh-10rem)]",children:["bestiary"===u?n.length?(0,t.jsx)(s.default,{entries:n,variant:"reference"}):(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Nothing revealed to you yet."}):null,"sheet"===u?d?(0,t.jsx)(h,{characterName:i,sheetRaw:d,legacyReportCard:c,itemsRaw:o}):(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"No character sheet found."}):null,"notes"===u?(0,t.jsx)(y,{campaignId:e,encounterId:l,characterId:a}):null,"quest"===u?(0,t.jsx)(b,{campaignId:e}):null]})]})})}function N({active:e,onClick:a,children:r}){return(0,t.jsx)("button",{type:"button",onClick:a,className:`px-3 py-2 rounded-xl border text-sm ${e?"bg-black text-white border-black":"hover:bg-gray-50"}`,children:r})}function _(e){if(e&&"object"==typeof e)return e;if("string"==typeof e)try{let t=JSON.parse(e);return t&&"object"==typeof t?t:{}}catch{}return{}}function w({campaignId:e,characterId:s,characterName:l}){let n=(0,r.useMemo)(()=>(0,i.createSupabaseBrowserClient)(),[]),d=(0,r.useRef)(null),c=(0,r.useRef)(!1),o=(0,r.useRef)(Date.now()),u=(0,r.useRef)(!1),m=(0,r.useRef)(null);function x(){o.current=Date.now(),c.current||(c.current=!0,setTimeout(async()=>{c.current=!1,await eN({silent:!0})},150))}let[p,h]=(0,r.useState)(!0),[g,f]=(0,r.useState)(null),[y,v]=(0,r.useState)(null),[b,N]=(0,r.useState)(null),[w,k]=(0,r.useState)([]),[S,C]=(0,r.useState)(null),[O,P]=(0,r.useState)({}),[q,M]=(0,r.useState)({}),[I,T]=(0,r.useState)([]),[$,A]=(0,r.useState)(null),[R,E]=(0,r.useState)(null),[D,F]=(0,r.useState)(null),[L,B]=(0,r.useState)(null),[H,U]=(0,r.useState)(!1),[J,z]=(0,r.useState)(null),[K,Q]=(0,r.useState)(null),[V,W]=(0,r.useState)(null),[G,Y]=(0,r.useState)(null),[X,Z]=(0,r.useState)(""),[ee,et]=(0,r.useState)([]),[ea,er]=(0,r.useState)([]),[ei,es]=(0,r.useState)(null),[el,en]=(0,r.useState)(null),[ed,ec]=(0,r.useState)([]),eo=y?.active_encounter_id??null;d.current=eo;let eu=(0,r.useMemo)(()=>{let e=[...S?.hand??[]];return e.sort((e,t)=>(O[e]??"").localeCompare(O[t]??"")),e},[S?.hand,O]),em=null===$?null:eu[$]??null;async function ex(e){if(f(null),!S?.id)return void f("No combat deck for this encounter.");let t=await fetch("/api/encounter/play/hand/to-discard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deckStateId:S.id,cardId:e})}),a=await t.json().catch(()=>({}));t.ok?(A(null),await eN()):f(a?.error??"Failed to move card")}async function ep(t,a){if(!eo)return;let r=O[a]??"",i=await fetch("/api/encounter/play/log-card",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaignId:e,encounterId:eo,characterId:s,action:t,cardId:a,cardName:r})}),l=await i.json().catch(()=>({}));i.ok||f(l?.error??"Failed to write log")}async function eh(){if(f(null),!S?.id)return void f("No combat deck for this encounter.");let e=await fetch("/api/encounter/play/draw-to-limit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deckStateId:S.id})}),t=await e.json().catch(()=>({}));e.ok?await eN():f(t?.error??"Failed to draw")}async function eg(){if(f(null),!eo)return;let t=await fetch("/api/encounter/play/set-hp-current",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaignId:e,encounterId:eo,characterId:s,hpCurrent:X})}),a=await t.json().catch(()=>({}));if(!t.ok)return void f(a?.error??"Failed to update HP");let r=Number.isFinite(Number(a?.hpCurrent))?Math.trunc(Number(a.hpCurrent)):null,i=Number.isFinite(Number(a?.hpMax))?Math.trunc(Number(a.hpMax)):null;W(r),null!==i&&Y(i),u.current=!1,Z(null===r?"":String(r)),K&&null!==r&&k(e=>e.map(e=>e.id===K?{...e,hp_current:r,hp_max:i??e.hp_max}:e)),setTimeout(()=>x(),400)}async function ef(t){let{data:a,error:r}=await n.from("encounter_log").select("id, created_at, kind, visibility, payload").eq("campaign_id",e).eq("encounter_id",t).order("created_at",{ascending:!1}).limit(50);r||et(a??[])}async function ey(e){let t={},a={};for(let r of e??[]){let e=String(r.id);t[e]=r.name??"(unnamed)";let i=_(r.structured),s="string"==typeof r.image_path?r.image_path:null,l="string"==typeof i?.image_path?i.image_path:null,d=s??l;if(d){let{data:t}=n.storage.from("card-images").getPublicUrl(d);a[e]=t?.publicUrl??null}else a[e]=null}P(e=>({...e,...t})),M(e=>({...e,...a}))}async function ev(e){F(e),B(null),z(null),U(!0);let{data:t,error:a}=await n.from("cards").select("id,name,rules_text,image_path,structured").eq("id",e).maybeSingle();if(a||!t){z(a?.message??"Card not found"),U(!1);return}let r=_(t.structured),i="string"==typeof t.image_path?t.image_path:null,s="string"==typeof r?.image_path?r.image_path:null,l=i??s,d=l?n.storage.from("card-images").getPublicUrl(l).data?.publicUrl??null:null;B({...t,imageUrl:d}),U(!1)}async function eb(){let{data:t,error:a}=await n.from("decks").select("id").eq("campaign_id",e).eq("character_id",s).eq("deck_type","exploration").maybeSingle();if(a)return void f(a.message);if(!t?.id)return void T([]);let{data:r,error:i}=await n.from("deck_cards").select("card_id, quantity").eq("deck_id",t.id);if(i)return void f(i.message);let l=(r??[]).map(e=>({card_id:e.card_id,qty:Number(e.quantity??0)})).filter(e=>e.card_id&&e.qty>0);T(l);let d=l.map(e=>e.card_id);if(d.length>0){let{data:e,error:t}=await n.from("cards").select("id,name,structured,image_path").in("id",d);if(t)return void f(t.message);await ey(e??[])}}async function ej(){let t,a,r,i,l,{data:d,error:c}=await n.from("bestiary_entries").select("id,category,reveal_level,created_at,revealed").eq("campaign_id",e).eq("character_id",s).order("category",{ascending:!0}).order("created_at",{ascending:!1});c&&f(c.message),er(d??[]);let{data:o,error:u}=await n.from("characters").select("sheet").eq("id",s).eq("campaign_id",e).single();if(u)return void f(u.message);let m=o?.sheet??{},x=(t=m?.characterSheet??{},a=t?.hp??{},r=t?.derived??{},i=a?.current??t?.hpCurrent??t?.currentHp??null,l=r?.hpMaxOverride??r?.hpCurrent??a?.max??t?.hpMax??t?.maxHp??null,{current:Number.isFinite(Number(i))?Number(i):null,max:Number.isFinite(Number(l))?Number(l):null});W(x.current),Y(x.max),Z(null===x.current?"":String(x.current));let p=m.characterSheet??null,h=m.reportCard??null,g=Array.isArray(m.items)?m.items:[];es(p),en(h),ec(g)}async function eN(t){let a=!!t?.silent;a||h(!0),f(null);let{data:r,error:i}=await n.from("campaign_state").select("campaign_id, mode, active_encounter_id").eq("campaign_id",e).maybeSingle();if(i){f(i.message),a||h(!1);return}if(v(r??{campaign_id:e,mode:"exploration",active_encounter_id:null}),"combat"===(r?.mode??"exploration")&&r?.active_encounter_id){let t=r.active_encounter_id,{data:i,error:l}=await n.from("encounters").select("id, status, round_number, turn_index").eq("id",t).single();if(l){f(l.message),a||h(!1);return}N(i);let{data:d,error:c}=await n.from("encounter_log").select("id, created_at, kind, visibility, payload").eq("campaign_id",e).eq("encounter_id",t).order("created_at",{ascending:!1}).limit(30);if(c){f(c.message),a||h(!1);return}et(d??[]);let{data:o,error:x}=await n.from("encounter_combatants").select("id, kind, name, character_id, order_index, is_hidden, is_defeated, status_public, death_saves_successes, death_saves_failures, hp_current, hp_max").eq("campaign_id",e).eq("encounter_id",t).order("order_index",{ascending:!0}).order("created_at",{ascending:!0});if(x){f(x.message),a||h(!1);return}k(o??[]);let p=(o??[]).find(e=>"character"===e.kind&&e.character_id===s);Q(p?.id??null),"number"==typeof p?.hp_current&&p.hp_current,"number"==typeof p?.hp_max&&p.hp_max;let g="number"==typeof p?.hp_current?p.hp_current:null,y="number"==typeof p?.hp_max?p.hp_max:null,v=m.current;v&&Date.now()<v.until?(g!==v.cur&&(g=v.cur),null!==v.max&&y!==v.max&&(y=v.max)):v&&(m.current=null),v&&g===v.cur&&(m.current=null),W(g),Y(y),u.current||Z(null===g?"":String(g));let{data:b,error:j}=await n.from("combat_deck_state").select("id,campaign_id,encounter_id,character_id,deck_id,hand_limit,draw_pile,hand,discard_pile,updated_at").eq("campaign_id",e).eq("encounter_id",t).eq("character_id",s).maybeSingle();if(j){f(j.message),a||h(!1);return}C(b??null);let _=Array.from(new Set([...b?.draw_pile??[],...b?.hand??[],...b?.discard_pile??[]]));if(_.length>0){let{data:e,error:t}=await n.from("cards").select("id,name,structured,image_path").in("id",_);if(t){f(t.message),a||h(!1);return}await ey(e??[])}T([]),a||h(!1);return}N(null),et([]),k([]),C(null),await eb(),a||h(!1)}(0,r.useEffect)(()=>{eN(),ej()},[e]),(0,r.useEffect)(()=>{if(!e)return;let t={current:"INIT"},a=n.channel(`play-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"campaign_state",filter:`campaign_id=eq.${e}`},()=>x()).on("postgres_changes",{event:"*",schema:"public",table:"encounters",filter:`campaign_id=eq.${e}`},()=>x()).on("postgres_changes",{event:"*",schema:"public",table:"encounter_combatants",filter:`campaign_id=eq.${e}`},()=>x()).on("postgres_changes",{event:"*",schema:"public",table:"combat_deck_state",filter:`campaign_id=eq.${e}`},e=>{(e.new?.character_id??e.old?.character_id??null)===s&&x()}).on("postgres_changes",{event:"*",schema:"public",table:"encounter_log",filter:`campaign_id=eq.${e}`},()=>{let e=d.current;e&&ef(e)}).subscribe(e=>{t.current=e}),r=setInterval(()=>{Date.now()-o.current>4e3&&x();let e=d.current;e&&ef(e)},2e3);return()=>{clearInterval(r),n.removeChannel(a)}},[e,s]);let e_=w.filter(e=>!e.is_defeated),ew=b?.turn_index??0,ek=e_[ew],eS=ek?.character_id===s,eC=y?.mode??"exploration",eO=S?.draw_pile?.length??0,eP=S?.hand?.length??0,eq=S?.discard_pile?.length??0,eM=S?.hand_limit??4,eI=[...I].sort((e,t)=>(O[e.card_id]??"").localeCompare(O[t.card_id]??""));return(0,t.jsxs)("main",{className:"p-6 pb-56",children:[(0,t.jsxs)("header",{className:"space-y-2 max-w-6xl",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-semibold",children:"Play"}),(0,t.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,t.jsx)("span",{className:"font-medium text-gray-800",children:"You:"})," ",l," · ",(0,t.jsx)("span",{className:"font-medium text-gray-800",children:"Mode:"})," ",y?.mode??"unknown"]})]}),(0,t.jsxs)("div",{className:"flex gap-2 flex-wrap",children:[(0,t.jsx)(a.default,{className:"underline text-sm",href:`/app/c/${e}`,children:"← Back to campaign"}),(0,t.jsx)("button",{onClick:()=>{eN(),ej()},disabled:p,className:"px-3 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50",children:"Reload"})]})]}),g?(0,t.jsxs)("p",{className:"text-sm text-red-600",children:["Error: ",g]}):null]}),(0,t.jsxs)("div",{className:"max-w-6xl mt-6 lg:flex gap-4",children:[(0,t.jsxs)("section",{className:"flex-1 border rounded-2xl p-4 space-y-4 min-w-0",children:[(0,t.jsx)("h2",{className:"font-medium",children:"Encounter"}),eo?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex gap-4 flex-wrap text-sm text-gray-600",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-800",children:"Round:"})," ",b?.round_number??"?"]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-800",children:"Turn:"})," ",0===e_.length?"?":`${ew+1} / ${e_.length}`]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-medium text-gray-800",children:"Status:"})," ",b?.status??"?"]})]}),y?.mode==="combat"?(0,t.jsxs)("div",{className:`border rounded-xl p-3 ${eS?"bg-green-50 border-green-300":""}`,children:[(0,t.jsx)("div",{className:"font-medium",children:eS?"✅ It’s your turn!":"Waiting..."}),(0,t.jsxs)("div",{className:"text-sm text-gray-600",children:["Current: ",ek?.name??"(unknown)"]})]}):null,(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("h3",{className:"font-medium",children:"Turn order"}),(0,t.jsx)("ul",{className:"space-y-2",children:w.map(e=>{var a;let r=e_.findIndex(t=>t.id===e.id),i=r===ew&&-1!==r;return(0,t.jsxs)("li",{className:`border rounded-xl p-3 ${i?"bg-yellow-50 border-yellow-300":""} ${e.is_defeated?"opacity-60":""}`,children:[(0,t.jsxs)("div",{className:"font-medium",children:[i?"⭐ ":"",e.name??"(no name)",e.character_id===s?" (you)":""]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["kind: ",e.kind," · defeated: ",String(e.is_defeated)]}),"character"===e.kind?(0,t.jsxs)("div",{className:"mt-2 flex items-center gap-2 flex-wrap text-xs text-gray-600",children:[(0,t.jsx)("span",{className:"font-medium text-gray-700",children:"Death saves:"}),(0,t.jsxs)("span",{className:"border rounded-full px-2 py-1",children:["✅ ",e.death_saves_successes??0,"/3"]}),(0,t.jsxs)("span",{className:"border rounded-full px-2 py-1",children:["❌ ",e.death_saves_failures??0,"/3"]})]}):null,"character"===e.kind&&e.character_id===s?(0,t.jsxs)("div",{className:"mt-2 flex items-center gap-2 flex-wrap",children:[(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"HP:"}),(0,t.jsx)("input",{className:"px-2 py-1 border rounded-md w-20",inputMode:"numeric",value:X,onChange:e=>{u.current=!0,Z(e.target.value)},placeholder:null===V?"?":String(V)}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:["/ ",G??"?"]}),(0,t.jsx)("button",{type:"button",onClick:eg,disabled:p||!K,className:"px-3 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50 text-sm",children:"Save HP"})]}):null,(0,t.jsx)("div",{className:"flex gap-2 flex-wrap mt-2",children:(!Array.isArray(a=e.status_public)?[]:a.map(e=>{if("string"==typeof e)return{label:e,remaining:1};if(e&&"object"==typeof e){let t=String(e.label??"").trim(),a=Number(e.remaining);return t?{label:t,remaining:Number.isFinite(a)?a:1}:null}return null}).filter(Boolean)).map(e=>(0,t.jsxs)("span",{className:"border rounded-full px-3 py-1 text-sm",children:[e.label," (",e.remaining,")"]},e.label))})]},e.id)})})]}),(0,t.jsxs)("section",{className:"border rounded-2xl p-4 space-y-2",children:[(0,t.jsx)("h3",{className:"font-medium",children:"Encounter log"}),0===ee.length?(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"No log entries yet."}):(0,t.jsx)("ul",{className:"space-y-2",children:ee.map(e=>{let a=e.payload??{},r="";if("note"===e.kind)r=String(a.text??"").trim()||"(note)";else if("card"===e.kind){let e=a.action,t=a.card_name??"(card)",i=a.character_name??"Someone";r=`${i} ${"play"===e?"played":"discarded"} ${t}`}else r=`${e.kind??"log"} entry`;return(0,t.jsx)("li",{className:"text-sm",children:"card"===e.kind?(0,t.jsxs)("div",{children:[(0,t.jsxs)("span",{children:[a.character_name??"Someone"," "]}),(0,t.jsxs)("span",{children:["play"===a.action?"played":"discarded"," "]}),(0,t.jsx)("button",{type:"button",className:"underline",onClick:()=>{let e="string"==typeof a.card_id?a.card_id:"";e&&ev(e)},children:a.card_name??"(card)"}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleString()})]}):(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{children:r}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleString()})]})},e.id)})})]})]}):(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"No active encounter."})]}),(0,t.jsx)(j,{campaignId:e,characterId:s,characterName:l,activeEncounterId:eo,bestiaryEntries:ea,characterSheetRaw:ei,legacyReportCardRaw:el,itemsRaw:ed})]}),(0,t.jsx)("div",{className:"fixed bottom-0 left-0 right-0 border-t bg-white/95 backdrop-blur",children:(0,t.jsx)("div",{className:"max-w-6xl mx-auto p-3 space-y-2",children:"combat"===eC?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-end gap-3",children:[(0,t.jsxs)("button",{type:"button",onClick:()=>E("discard"===R?null:"discard"),className:"w-[140px] border rounded-2xl p-3 hover:bg-gray-50 text-left shrink-0",children:[(0,t.jsx)("div",{className:"text-xs text-gray-600",children:"Discard"}),(0,t.jsx)("div",{className:"font-semibold",children:eq}),(0,t.jsx)("div",{className:"text-[11px] text-gray-500",children:"Tap to view"})]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0 border rounded-2xl p-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,t.jsxs)("div",{className:"text-xs text-gray-600",children:["Hand (",eP," / ",eM,")"]}),(0,t.jsx)("button",{onClick:eh,disabled:p||!S,className:"px-3 py-2 rounded-xl border hover:bg-gray-50 disabled:opacity-50 text-sm",title:"Draw until you reach your hand limit",children:"Draw to limit"})]}),S?0===eP?(0,t.jsx)("div",{className:"text-sm text-gray-500 mt-2",children:"Empty"}):(0,t.jsx)("div",{className:"mt-3 overflow-x-auto",children:(0,t.jsx)("div",{className:"flex gap-4 justify-center min-w-max px-2",children:eu.map((e,a)=>{let r=$===a,i=O[e]??e,s=q[e]??null;return(0,t.jsxs)("div",{className:"w-[160px]",children:[(0,t.jsxs)("button",{type:"button",onClick:()=>A(r?null:a),onContextMenu:t=>{t.preventDefault(),ev(e)},className:`w-full border rounded-2xl p-2 hover:bg-gray-50 ${r?"bg-yellow-50 border-yellow-300":""}`,title:"Left click: actions · Right click: view card",children:[s?(0,t.jsx)("img",{src:s,alt:i,className:"w-full aspect-[785/1100] object-cover rounded-xl border bg-white"}):(0,t.jsx)("div",{className:"w-full aspect-[785/1100] rounded-xl border bg-gray-50 grid place-items-center text-xs text-gray-500",children:"No image"}),(0,t.jsx)("div",{className:"mt-2 text-sm font-medium leading-tight line-clamp-2",children:i})]}),r&&em?(0,t.jsxs)("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[(0,t.jsx)("button",{type:"button",onClick:async()=>{await ex(em),await ep("play",em)},disabled:p,className:"px-3 py-2 rounded-xl border hover:bg-gray-50 disabled:opacity-50 text-sm",children:"Play"}),(0,t.jsx)("button",{type:"button",onClick:async()=>{await ex(em),await ep("discard",em)},disabled:p,className:"px-3 py-2 rounded-xl border hover:bg-gray-50 disabled:opacity-50 text-sm",children:"Discard"})]}):null]},`${e}-${a}`)})})}):(0,t.jsx)("div",{className:"text-sm text-gray-500 mt-2",children:"No combat deck for this encounter."})]}),(0,t.jsxs)("button",{onClick:()=>E("draw"===R?null:"draw"),className:"w-[140px] border rounded-2xl p-3 hover:bg-gray-50 text-left shrink-0",children:[(0,t.jsx)("div",{className:"text-xs text-gray-600",children:"Deck"}),(0,t.jsx)("div",{className:"font-semibold",children:eO}),(0,t.jsx)("div",{className:"text-[11px] text-gray-500",children:"Tap to view"})]})]}),R?(0,t.jsx)("div",{className:"px-1 pb-1",children:(0,t.jsxs)("div",{className:"border rounded-2xl p-3 space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[(0,t.jsxs)("div",{className:"text-sm text-gray-700",children:["Viewing ",(0,t.jsx)("span",{className:"font-medium",children:R})," pile (alphabetical)"]}),(0,t.jsx)("button",{type:"button",className:"underline text-sm",onClick:()=>E(null),children:"close"})]}),S?(()=>{let e="draw"===R?S.draw_pile??[]:S.discard_pile??[];if(0===e.length)return(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"Empty."});let a={};for(let t of e)a[t]=(a[t]??0)+1;let r=Object.entries(a).map(([e,t])=>({id:e,qty:t,name:O[e]??e})).sort((e,t)=>e.name.localeCompare(t.name));return(0,t.jsx)("ul",{className:"space-y-1",children:r.map(e=>(0,t.jsxs)("li",{className:"text-sm text-gray-700",children:[e.name," ",e.qty>1?(0,t.jsxs)("span",{className:"text-gray-500",children:["×",e.qty]}):null]},e.id))})})():(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"No deck state."})]})}):null]}):(0,t.jsxs)("div",{className:"border rounded-2xl p-3",children:[(0,t.jsx)("div",{className:"text-xs text-gray-600",children:"Exploration hand"}),0===eI.length?(0,t.jsx)("div",{className:"text-sm text-gray-500 mt-2",children:"No exploration deck found."}):(0,t.jsx)("div",{className:"mt-3 overflow-x-auto",children:(0,t.jsx)("div",{className:"flex gap-4 justify-center min-w-max px-2",children:eI.map(e=>{let a=O[e.card_id]??e.card_id,r=q[e.card_id]??null;return(0,t.jsx)("div",{className:"w-[160px]",children:(0,t.jsx)("div",{className:"w-[160px]",children:(0,t.jsxs)("button",{type:"button",onContextMenu:t=>{t.preventDefault(),ev(e.card_id)},className:"w-full border rounded-2xl p-2 hover:bg-gray-50 text-left",title:"Right click: view card",children:[r?(0,t.jsx)("img",{src:r,alt:a,className:"w-full aspect-[785/1100] object-cover rounded-xl border bg-white"}):(0,t.jsx)("div",{className:"w-full aspect-[785/1100] rounded-xl border bg-gray-50 grid place-items-center text-xs text-gray-500",children:"No image"}),(0,t.jsxs)("div",{className:"mt-2 flex items-start justify-between gap-2",children:[(0,t.jsx)("div",{className:"text-sm font-medium leading-tight line-clamp-2",children:a}),e.qty>1?(0,t.jsxs)("div",{className:"text-xs border rounded-full px-2 py-1",children:[e.qty,"×"]}):null]})]})},e.card_id)},e.card_id)})})}),(0,t.jsx)("div",{className:"text-xs text-gray-500 mt-2",children:"Exploration mode has no draw/discard mechanics."})]})})}),D&&(0,t.jsx)("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center p-4",onClick:()=>{F(null),B(null),z(null)},children:(0,t.jsxs)("div",{className:"bg-white text-black w-full max-w-3xl rounded-2xl p-4 space-y-3",onClick:e=>e.stopPropagation(),children:[(0,t.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"text-xl font-semibold",children:L?.name??(H?"Loading…":"Card")}),J?(0,t.jsx)("div",{className:"text-sm text-red-600",children:J}):null]}),(0,t.jsx)("button",{className:"border rounded-md px-3 py-2",onClick:()=>{F(null),B(null),z(null)},children:"Close"})]}),H?(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"Loading…"}):L?(0,t.jsxs)(t.Fragment,{children:[L.imageUrl?(0,t.jsx)("img",{src:L.imageUrl,alt:L.name??"Card",className:"w-full max-h-[420px] object-contain rounded-lg border bg-white"}):(0,t.jsx)("div",{className:"w-full h-[220px] rounded-lg border bg-gray-50 grid place-items-center text-sm text-gray-500",children:"No image"}),(0,t.jsx)("div",{className:"max-h-[45vh] overflow-y-auto pr-1",children:(0,t.jsx)("div",{className:"text-sm whitespace-pre-wrap text-gray-800",children:L.rules_text??""})})]}):null]})})]})}e.s(["default",()=>w],20846)}]);